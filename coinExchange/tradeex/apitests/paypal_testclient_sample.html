
<!DOCTYPE html>

{# check https://developer.paypal.com/demo/checkout/#/pattern/client and paste below code to run paypal checkout button test#}

<head>
    <!-- Add meta tags for mobile and IE -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
</head>

<body>
    <!-- Set up a container element for the button -->
    <div id="paypal-button-container"></div>

    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

    <script>
        paypal.Buttons({
        createOrder: function (data, actions) {

          var units = 2;
          var units_val = parseFloat(units);
          var unit_price = 2.4;
          var total_amount = (units_val * unit_price).toFixed(2);

          var data = new FormData();
          data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
          data.append('quantity', units);
          data.append('unit_price', unit_price);
          data.append('seller_payment_provider', 'paypal');

          data.append('unit_price_currency', 'CAD');
          data.append('crypto', 'axfund');
          data.append('total_amount', total_amount);

          return fetch('http://localhost:8080/trading/purchase/create_paypal_order/', {
            method: 'POST',
            body: data,
            credentials: 'same-origin',
          }).then(function(res) {
            return throw_if_fetch_error(res)
          }).then(function(res) {
              return res.json();
          }).then(function(data) {
              return data.orderID;
          }).catch(error => {
            console.log(error);
            alert("无法生成 PayPal支付， 请稍后再试")
          });
        },

        onApprove: function (data, actions) {
          return actions.order.capture().then(function (details) {
            return fetch('http://localhost:8080/trading/paypal/confirm_payment/', {
              method: 'post',
              body: JSON.stringify({
                orderID: data.orderID,
                details: details,
                buy_order_id: details.purchase_units[0].reference_id,
                amount: details.purchase_units[0].amount
              }),
            }).then(function(res) {
              return throw_if_fetch_error(res)
            }).then(function(data) {
              alert("支付成功！")
            }).catch(error => {
              console.log(error);
              alert("无法确认 PayPal支付是否成功，请稍后查看")
            });
          });
        },

        style: {
          layout: 'vertical',
          color: 'gold',
          shape: 'rect',
          label: 'paypal',
          tagline: false
        }
      }).render('#paypal-button-container');
    </script>
</body>
