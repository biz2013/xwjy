<!DOCTYPE html>
<html lang="en-us">

<head>
  {% include 'html/include/common_header.html' %}
</head>

<body>
  <!-- menu section -->
  {% include "html/include/topmenu.html" %}
  <!-- body section -->
  {% load mathfilters %}
  <script language="JavaScript">
    function show_order_info(orderid, units, unit_price, unit_price_currency) {
      $("#id_units_confirm").text(units);
      $("#id_units_price_confirm").text(unit_price + ' ' + unit_price_currency);
      $("#id_total_amount_confirm").text(parseFloat(units * unit_price).toFixed(2) + ' ' + unit_price_currency);
      $("#id_order_id_confirm").val(orderid);
    }
  </script>
  <div class="container">
    <h6>锁定余额: {{ axfund.locked_balance }} 可用余额: {{ axfund.available_balance }} 总余额：{{ axfund.balance}} </h6>
    <div class="well">
      <div class="row">
        {% if previous_call_status %}
        {% if previous_call_status.status == 'OK' %}
        <div id="div_previous_call_status" class="text-success">{{ previous_call_status.message }}</div>
        {% else %}
        <div id="div_previous_call_status" class="text-danger">{{ previous_call_status.message }}</div>
        {% endif %}
        {% endif %}
        {% if buyorders %}
        <h4>给我的买单</h4>
        <table class="table ">
          <tr>
            <td>购买数量</td>
            <td>单价</td>
            <td>总额</td>
            <!--<td>更改时间</td>-->
          </tr>
          {% for order in buyorders %}
          <tr>
            <td>{{ order.total_units }}</td>
            <td>{{ order.unit_price }}&nbsp;{{ order.unit_price_currency }}</td>
            <td>{{ order.total_units|mul:order.unit_price }}&nbsp;{{ order.unit_price_currency }}</td>
            <!--<td>{{ order.lastmodified_at }}</td>-->
            <td>{% if order.status == 'PAID' %}
              <button class="btn btn-primary" data-toggle="modal" data-target="#payment-confirm-modal" onclick="show_order_info({{ order.order_id}}, {{ order.total_units}},{{ order.unit_price }}, '{{ order.unit_price_currency}}')">确认</button> {% else %}等待付款 {% endif %}
            </td>
            <td>{% if order.status == 'PAID' %}<button class="btn btn-warning" id="id_arbitrage">争议</button> {% else %} &nbsp; {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
        {% endif %}
      </div>
      <div class="row">
        <table class="table table-condensed">
          <tr>
            <th>
              <h4>卖单状况</h4>
            </th>
            <th><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sell-modal">添加卖单</button></th>
          </tr>
        </table>
        <table class="table table-striped table-condensed">
          <tr>
            <th>数量</th>
            <th>单价</th>
            <th>余额</th>
            <!--<th>更改时间</th>-->
          </tr>
          {% if sellorders %} {% for order in sellorders %}
          <tr>
            <td>{{ order.available_units }}</td>
            <td>{{ order.unit_price }}&nbsp;{{ order.unit_price_currency }}
              <td>{{ order.available_units|mul:order.unit_price }}&nbsp;{{ order.unit_price_currency }}</td>
              <!--<td>{{ order.lastmodified_at }}</td>-->
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td>暂时没有活跃的卖单</td>
            <td>
          </tr>
          {% endif %}
        </table>
      </div>
    </div>
    <!-- popup window for confirm payment of purchase -->
    <form id="payment-confirm-modal" tabindex="-1" class="modal fade" role="dialog" action="/mysellorder/confirm_payment/" aria-labelledby="confirm-form-label" aria-hidden="true" method='post'>
      {% csrf_token %}
      <input type="hidden" id="id_username_confirm" name="username" value="{{ username }}" />
      <input type="hidden" id="id_order_id_confirm" name="order_id" value=""/>
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 id="confirm-form-label">确认付款</h4>
          </div>
          <div class="modal-body">
            <div id="div_purchase_content" class="form-group">
              <table class="table">
                <tr>
                  <td><label class="control-label">数量</label></td>
                  <td><label class="control-label" id="id_units_confirm">&nbsp;</label>
                </tr>
                <tr>
                  <td><label class="control-label">单价</label></td>
                  <td><label class="control-label" id="id_units_price_confirm">&nbsp;</label>
                </tr>
                <tr>
                  <td><label class="control-label">总额</label></td>
                  <td><label class="control-label" id="id_total_amount_confirm">&nbsp;</label>
                </tr>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-default" data-dismiss="submit">确认</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">撤销</button>
          </div>
        </div>
      </div>
    </form>
    <!-- popup window for purchase -->
    <script language="JavaScript">
    function create_sell_order() {
      units = $("#id_quantity").val();
      price = $("#id_unit_price").val();
      if (isNaN(units)) {
        $("#error-message-sell-modal").val("请输入正确的出售数量");
        return;
      }

      if (isNaN(price)) {
        $("#error-message-sell-modal").val("请输入正确的单价");
        return;
      }

      units_val = parseFloat(units).toFixed(2);
      price_val = parseFloat(price).toFixed(2);
      if (units_val < 0.01) {
        $("#error-message-sell-modal").val("请输入出售数量");
        return;
      }
      if (price_val < 0.01) {
        $("#error-message-sell-modal").val("请输入单价");
        return;
      }

      $("#sell-modal").submit();
    }
    function show_total_amount(units, price) {
      if (!isNaN(units) && !isNaN(price)) {
        $("#total_amount").text(" " + (parseFloat(units) * parseFloat(price)).toFixed(2));
      }
    }
    </script>
    <form id="sell-modal" tabindex="-1" class="modal fade" role="dialog" action="/mysellorder/" aria-labelledby="purchase-form-label" aria-hidden="true" method='post'>
      {% csrf_token %}
      <input type="hidden" id="id_username" name="username" value="{{ username }}" />
      <input type="hidden" id="id_unit_price_currency" name="unit_price_currency" value="CYN"/>
      <input type="hidden" id="id_crypto" name="crypto" value="axfund" />
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 id="purchase-form-label">出售美基金</h4>
          </div>
          <div class="text-danger" id="error-message-sell-modal"></div>
          <div class="modal-body">
            <div id="div_id_quantity" class="form-group">
              <label for="id_quantitiy" class="control-label">数量</label><span class="asteriskField">*</span> </label>
              <div class="controls "> <input class="textinput textInput form-control" id="id_quantity" maxlength="10" name="quantity" type="text" onkeyup="show_total_amount(this.value, $('#id_unit_price').val())" /> </div>
            </div>
            <div id="div_id_quantity" class="form-group">
              <label for="id_unit_price" class="control-label">单价(CYN)</label><span class="asteriskField">*</span> </label>
              <div class="controls "> <input class="textinput textInput form-control" id="id_unit_price" maxlength="10" name="unit_price" type="text" onkeyup="show_total_amount($('#id_quantity').val(), this.value)"/> </div>
            </div>
            <div id="div_id_total" class="form-group">
              <label class="control-label">总额</label><div id="total_amount"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="submit" onclick="create_sell_order()">确认</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">撤销</button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- footer section-->
  {% include 'html/include/footer.html' %}
</body>
<script>
</script>

</html>
